#!/usr/bin/env bash
# This script configures Nginx to run as the 'nginx' user and listen on port 8080.

# Ensure the script is run as root
if [[ "$(id -u)" -ne 0 ]]; then
    echo "This script must be run as root"
    exit 1
fi

# Step 1: Update nginx.conf to run as nginx user
NGINX_CONF="/etc/nginx/nginx.conf"
USER_DIRECTIVE="user nginx;"
# Check and modify nginx user
if grep -q "^user" "$NGINX_CONF"; then
    sed -i "s/^user .*/$USER_DIRECTIVE/" "$NGINX_CONF"
else
    sed -i "1i $USER_DIRECTIVE" "$NGINX_CONF"
fi
echo "Nginx configuration updated to run as nginx user."

# Step 2: Modify default site configuration to listen on port 8080
DEFAULT_SITE="/etc/nginx/sites-available/default"
if ! grep -q "listen 8080" "$DEFAULT_SITE"; then
    sed -i "/listen 80/c\    listen 8080;" "$DEFAULT_SITE"
    echo "Default site updated to listen on port 8080."
fi

# Step 3: Reload Nginx to apply changes
nginx -t && systemctl reload nginx
echo "Nginx reloaded with new configuration."

# Additional debug output to verify
echo "Current Nginx processes:"
ps aux | grep ngin[x]

echo "Checking port 8080 status:"
nc -zv 0.0.0.0 8080
